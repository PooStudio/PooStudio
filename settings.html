<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings ✦ POOSTUDIO</title>
  <link rel="icon" href="logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Helvetica+Neue&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="profile.css">
</head>
<body>

<div id="overlay">
  <div id="content">
    <div class="container glass">
      <header class="glass">
        <nav>
          <a href="profile.html" class="glitch" data-text="← Back">← Back</a>
        </nav>
        <div class="logo glitch aero-glow" data-text="POOSTUDIO">POOSTUDIO</div>
      </header>

      <div id="message-container"></div>

      <main class="glass" style="padding:1.5rem; margin-top:1rem;">
        <h2 class="glitch" data-text="Settings">Settings</h2>

        <section style="margin-top:1rem;">
          <label class="aero-glow" for="settings-display-name">Display Name</label>
          <div style="display:flex; gap:0.75rem; margin-top:0.5rem;">
            <input id="settings-display-name" type="text" placeholder="Enter new display name" style="flex:1;" />
            <button id="settings-save-name" class="btn btn-primary">Save</button>
          </div>
        </section>

        <section style="margin-top:1.25rem;">
          <label class="aero-glow">Profile Picture</label>
          <div style="display:flex; gap:0.75rem; align-items:center; margin-top:0.5rem;">
            <input id="settings-avatar-input" type="file" accept="image/*" style="display: none;" />
            <button id="settings-upload-avatar" class="btn btn-secondary">Upload</button>
            <button id="settings-save-avatar" class="btn btn-primary" style="display:none;">Save</button>
            <div id="avatar-preview" style="width:48px;height:48px;border-radius:50%;overflow:hidden;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:bold;color:#000;"></div>
          </div>
        </section>

        <section style="margin-top:1.5rem; display:flex; flex-direction:column; gap:0.6rem;">
          <button id="verify-email" class="btn btn-secondary">Send Verification Email</button>
          <button id="change-password" class="btn btn-secondary">Change Password</button>
          <button id="logout" class="btn logout-btn">Logout</button>
        </section>
      </main>

    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, sendEmailVerification, updatePassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";
  import { getFirestore, doc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBZuXpjaUPUm3b7QqVtzxEsRhBEESTHu1E",
    authDomain: "poostudios-20da0.firebaseapp.com",
    projectId: "poostudios-20da0",
    storageBucket: "poostudios-20da0.firebasestorage.app",
    messagingSenderId: "69493755317",
    appId: "1:69493755317:web:c1835df7c7b9eae9315dfc"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const db = getFirestore(app);

  const msgContainer = document.getElementById('message-container');

  function showMessage(text, isError = false) {
    const messageEl = document.createElement('div');
    messageEl.className = `message ${isError ? 'error' : ''} glass aero-glow`;
    messageEl.textContent = text;
    msgContainer.appendChild(messageEl);
    setTimeout(() => { messageEl.remove(); }, 4000);
  }

  function populateUser(user) {
    if (!user) return;
    document.getElementById('settings-display-name').value = user.displayName || '';
    const preview = document.getElementById('avatar-preview');
    if (user.photoURL) {
      preview.innerHTML = `<img src="${user.photoURL}" alt="avatar" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
      preview.textContent = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
    }
  }

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    populateUser(user);
  });

  async function uploadAvatarFile(file) {
    if (!file) return;
    const user = auth.currentUser;
    if (!user) { showMessage('Not authenticated', true); return; }
    try {
      async function resizeImage(fileBlob, size = 256) {
        const img = await createImageBitmap(fileBlob);
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        const { width, height } = img;
        const min = Math.min(width, height);
        const sx = (width - min) / 2;
        const sy = (height - min) / 2;
        ctx.drawImage(img, sx, sy, min, min, 0, 0, size, size);
        return await new Promise((res) => canvas.toBlob(res, 'image/jpeg', 0.9));
      }

      const resizedBlob = await resizeImage(file, 256);
      const form = new FormData();
      form.append('avatar', resizedBlob, 'avatar.jpg');
      form.append('uid', user.uid);
      const uploadEndpoint = (window.UPLOAD_ENDPOINT || (window.location.origin + '/upload-avatar'));
      const resp = await fetch(uploadEndpoint, { method: 'POST', body: form });
      if (!resp.ok) throw new Error('upload-failed');
      const data = await resp.json();
      const url = data.url && data.url.startsWith('http') ? data.url : (new URL(data.url, uploadEndpoint).href);
      await updateProfile(user, { photoURL: url });
      populateUser(user);
      showMessage('Profile picture updated.');
    } catch (err) {
      console.error(err);
      showMessage('Upload failed: ' + (err.message || err.code), true);
    }
  }

  let selectedAvatarFileSettings = null;
  const settingsAvatarInput = document.getElementById('settings-avatar-input');
  const settingsSaveAvatarBtn = document.getElementById('settings-save-avatar');
  const settingsUploadTrigger = document.getElementById('settings-upload-avatar');
  if (settingsAvatarInput) {
    settingsAvatarInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      selectedAvatarFileSettings = file;
      const preview = document.getElementById('avatar-preview');
      const reader = new FileReader();
      reader.onload = () => { preview.innerHTML = `<img src="${reader.result}" style="width:100%;height:100%;object-fit:cover;">`; };
      reader.readAsDataURL(file);
      if (settingsSaveAvatarBtn) settingsSaveAvatarBtn.style.display = 'inline-block';
    });
  }

  if (settingsUploadTrigger) {
    settingsUploadTrigger.addEventListener('click', () => {
      if (settingsAvatarInput) settingsAvatarInput.click();
    });
  }

  if (settingsSaveAvatarBtn) {
    settingsSaveAvatarBtn.addEventListener('click', async () => {
      if (!selectedAvatarFileSettings) return;
      await uploadAvatarFile(selectedAvatarFileSettings);
      selectedAvatarFileSettings = null;
      settingsSaveAvatarBtn.style.display = 'none';
    });
  }

  document.getElementById('settings-save-name').addEventListener('click', async () => {
    const newName = document.getElementById('settings-display-name').value.trim();
    if (!newName) { showMessage('Please enter a display name', true); return; }
    const user = auth.currentUser;
    if (!user) { showMessage('Not authenticated', true); return; }
    try {
      const claimUsername = async (user, desiredName) => {
        const key = desiredName.toLowerCase();
        const desiredRef = doc(db, 'usernames', key);
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(desiredRef);
          if (snap.exists() && snap.data().uid !== user.uid) throw new Error('username-taken');
          tx.set(desiredRef, { uid: user.uid, createdAt: serverTimestamp() });
          const old = (user.displayName || '').toLowerCase();
          if (old && old !== key) {
            const oldRef = doc(db, 'usernames', old);
            const oldSnap = await tx.get(oldRef);
            if (oldSnap.exists() && oldSnap.data().uid === user.uid) tx.delete(oldRef);
          }
        });
      };

      await claimUsername(user, newName);
      await updateProfile(user, { displayName: newName });
      showMessage('Display name updated.');
    } catch (err) {
      if (err && err.message === 'username-taken') {
        showMessage('That display name is already taken', true);
      } else {
        console.error(err);
        showMessage('Name update failed: ' + (err.message || err.code), true);
      }
    }
  });

  document.getElementById('verify-email').addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) { showMessage('Not authenticated', true); return; }
    try { await sendEmailVerification(user); showMessage('Verification email sent.'); } catch (err) { showMessage('Failed: ' + (err.message || err.code), true); }
  });

  document.getElementById('change-password').addEventListener('click', async () => {
    const newPassword = prompt('Enter your new password (min 8 chars):');
    if (!newPassword || newPassword.length < 8) { showMessage('Password must be at least 8 characters', true); return; }
    const user = auth.currentUser;
    if (!user) { showMessage('Not authenticated', true); return; }
    try { await updatePassword(user, newPassword); showMessage('Password updated.'); setTimeout(() => { signOut(auth); window.location.href='index.html'; }, 1800); } catch (err) { showMessage('Failed: ' + (err.message || err.code), true); }
  });

  document.getElementById('logout').addEventListener('click', async () => {
    try { await signOut(auth); window.location.href = 'index.html'; } catch (err) { showMessage('Logout failed: ' + (err.message || err.code), true); }
  });

</script>

</body>
</html>
