window.addEventListener("load", () => {
    document.getElementById("year").textContent = new Date().getFullYear();

    const starsContainer = document.getElementById("starsContainer");
    let idleTimeout;
    const idleTime = 30000;
    let starsInterval;

    function createStar() {
        const star = document.createElement("div");
        star.classList.add("star");
        star.textContent = 'ğŸ’©';
        star.style.left = `${Math.random() * 100}vw`;
        star.style.fontSize = `${Math.random() * 20 + 10}px`;
        star.style.animationDuration = `${Math.random() * 2 + 1}s`;
        star.style.color = `hsl(${Math.random() * 360}, 50%, 50%)`;
        starsContainer.appendChild(star);
        setTimeout(() => star.remove(), 3000);
    }

    function startStars() {
        starsContainer.style.display = "block";
        starsInterval = setInterval(createStar, 80); // even more chaos
        return starsInterval;
    }

    function stopStars() {
        clearInterval(starsInterval);
        starsContainer.innerHTML = "";
        starsContainer.style.display = "none";
    }

    function resetIdleTimer() {
        clearTimeout(idleTimeout);
        if (starsInterval) stopStars();
        idleTimeout = setTimeout(() => {
            starsInterval = startStars();
        }, idleTime);
    }

    window.addEventListener("mousemove", resetIdleTimer);
    window.addEventListener("keydown", resetIdleTimer);
    window.addEventListener("scroll", resetIdleTimer);
    window.addEventListener("touchstart", resetIdleTimer);
    resetIdleTimer();

    window.addEventListener('mousemove', (e) => {
        const xRel = (e.clientX / window.innerWidth - 0.5) * 2;
        const yRel = (e.clientY / window.innerHeight - 0.5) * 2;
        document.querySelector('.bg').style.transform = `translate(${xRel * 25}px, ${yRel * 25}px)`;
        document.querySelector('.moving-bg').style.transform = `translate(${xRel * 15}px, ${yRel * 15}px)`;
        document.querySelector('.container').style.transform = `translate(${xRel * 30}px, ${yRel * 30}px)`;
    });

    const canvas = document.getElementById('noise');
    const ctx = canvas.getContext('2d');
    const resizeCanvas = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    };
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function generateNoise() {
        const imageData = ctx.createImageData(canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const val = Math.floor(Math.random() * 255);
            data[i] = data[i + 1] = data[i + 2] = val;
            data[i + 3] = 255;
        }
        ctx.putImageData(imageData, 0, 0);
    }
    setInterval(generateNoise, 100);

    function createParticle() {
        const p = document.createElement('div');
        p.classList.add('particle');
        p.textContent = 'ğŸ’©';
        p.style.left = `${Math.random() * 100}%`;
        p.style.top = `${Math.random() * 100}%`;
        p.style.fontSize = `${Math.random() * 15 + 10}px`;
        p.style.setProperty('--dx', `${Math.random() * 200 - 100}px`);
        p.style.setProperty('--dy', `${Math.random() * 200 - 100}px`);
        p.style.animation = `drift ${Math.random() * 30 + 15}s linear forwards`;
        document.getElementById('particles').appendChild(p);
        setTimeout(() => p.remove(), 45000);
    }
    setInterval(createParticle, 1000);

    document.querySelectorAll('.distort').forEach(el => {
        const text = el.textContent;
        el.innerHTML = '';
        for (let char of text) {
            const span = document.createElement('span');
            span.textContent = char === ' ' ? '\u00A0' : char;
            span.style.animationDuration = `${Math.random() * 1 + 0.5}s`;
            span.style.animationDelay = `${Math.random() * 0.5}s`;
            el.appendChild(span);
        }
    });

    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });
    document.querySelectorAll('section').forEach(section => observer.observe(section));

    document.querySelector('.easter-egg').addEventListener('click', () => {
        alert('You poked the shadows! ğŸ’©ğŸ’©ğŸ’© CHAOS UNLEASHED ğŸ’©ğŸ’©ğŸ’©');
        for (let i = 0; i < 300; i++) {
            setTimeout(createParticle, i * 10);
            setTimeout(createStar, i * 15);
        }
        document.body.style.filter = 'invert(1) hue-rotate(180deg)';
        setTimeout(() => document.body.style.filter = '', 2500);
    });
});